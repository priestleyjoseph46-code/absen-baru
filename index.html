<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111827">
  <title>Absensi Minimal — Offline + Auto Sync</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#12172a;--muted:#9aa0b4;--accent:#2563eb;--ok:#16a34a;--bad:#ef4444;--ring:#60a5fa;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#e5e7eb;}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid #1f2540;border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:#1b2342;color:#fff;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.ok{background:var(--ok)}
    .btn.bad{background:var(--bad)}
    .btn.accent{background:var(--accent)}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #273055;background:#0f1430;color:#fff;outline:none}
    input:focus,select:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    .muted{color:var(--muted);font-size:13px}
    .title{font-weight:700;font-size:20px;margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#263057;color:#cbd5e1;font-size:12px}
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0b1020,rgba(11,16,32,.8));backdrop-filter:blur(8px);border-bottom:1px solid #1f2540}
    .topbar .inner{max-width:920px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #273055;background:#0f1430;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #202646;text-align:left;font-size:14px}
    th{color:#cbd5e1;font-weight:600}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#0f1430;border:1px solid #263057;border-radius:12px;padding:10px 14px;font-size:14px;z-index:1000}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <div style="display:flex;align-items:center;gap:10px">
        <strong>Absensi</strong>
        <span id="badgeOnline" class="pill">Offline</span>
        <span id="syncState" class="pill">Idle</span>
      </div>
      <div>
        <button id="btnToAdmin" class="btn">Admin</button>
        <button id="btnLogout" class="btn bad hidden">Keluar</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <section id="viewLogin" class="card">
      <h2 class="title">Masuk</h2>
      <div class="row">
        <div class="col">
          <label class="muted">User ID</label>
          <input id="loginId" placeholder="mis. 0001" autocomplete="username">
        </div>
        <div class="col">
          <label class="muted">Password</label>
          <input id="loginPass" type="password" placeholder="••••••" autocomplete="current-password">
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="btnLogin" class="btn accent">Masuk</button>
        <button id="btnRefreshEmployees" class="btn">Refresh Karyawan</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- USER -->
    <section id="viewUser" class="card hidden">
      <div class="row">
        <div class="col">
          <h2 class="title" id="userName">—</h2>
          <div class="muted">ID: <span id="userId">—</span> · Role: <span id="userRole">—</span></div>
        </div>
        <div class="col" style="text-align:right">
          <button id="btnChangePassSelf" class="btn">Ganti Password</button>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="card">
          <div class="muted">Tanggal</div>
          <div id="todayDate" style="font-weight:700;margin-top:4px"></div>
        </div>
        <div class="card">
          <div class="muted">Shift</div>
          <select id="shiftSel">
            <option value="">Pilih shift…</option>
            <option value="1">Shift 1 (07:00–15:00)</option>
            <option value="2">Shift 2 (15:00–23:00)</option>
            <option value="3">Shift 3 (23:00–07:00)</option>
            <option value="4">Fleksibel</option>
          </select>
        </div>
        <div class="card">
          <div class="muted">Status Hari Ini</div>
          <div id="statusIn">Masuk: -</div>
          <div id="statusOut">Keluar: -</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnIn" class="btn ok col">Finger In</button>
        <button id="btnOut" class="btn bad col">Finger Out</button>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="viewAdmin" class="card hidden">
      <div class="row" style="align-items:flex-end">
        <div class="col">
          <h2 class="title">Admin</h2>
          <div class="muted">Kelola karyawan & pantau data lokal</div>
        </div>
        <div class="col" style="text-align:right">
          <button id="btnBack" class="btn">Kembali</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label class="muted">Cari</label>
          <input id="searchEmp" placeholder="Cari nama/ID…">
        </div>
        <div class="col" style="display:flex;gap:10px;align-items:flex-end">
          <button id="btnReloadEmp" class="btn">Reload dari Sheet</button>
          <button id="btnExportLocal" class="btn">Export CSV Lokal</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>Daftar Karyawan</strong> <span id="empCount" class="badge">0</span></div>
          <div class="muted">Edit password: klik tombol di baris</div>
        </div>
        <div style="max-height:360px;overflow:auto">
          <table id="tblEmp">
            <thead><tr><th>ID</th><th>Nama</th><th>Role</th><th>Password</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzMR-FbZXZpNrc-p2xqHfoZSnggq57t8dZYV0Lv01rc3bFK_1qrRlEQEPyQnh__05MF1A/exec";

/* ===== STATE / STORAGE KEYS ===== */
const LS = {
  employees: "absensi_employees_v1",
  employeesFetchedAt: "absensi_employees_at_v1",
  session: "absensi_session_v1",
  attendance: "absensi_attendance_v1",
  queue: "absensi_queue_v1"
};
let EMP = []; // [{id,name,password,role}]
let currentUser = null;
let attendance = {}; // userId -> date -> {in,out,shift}
let queue = []; // outbox mirror

/* ===== UI HELPERS ===== */
function qs(id){return document.getElementById(id)}
function show(v){v.classList.remove("hidden")}
function hide(v){v.classList.add("hidden")}
function toast(m){const t=qs("toast");t.textContent=m;t.classList.remove("hidden");setTimeout(()=>t.classList.add("hidden"),1800)}
function setOnlineBadge(){qs("badgeOnline").textContent = navigator.onLine? "Online":"Offline"}
function setSyncState(t){qs("syncState").textContent=t}

/* ===== TIME ===== */
function todayKey(d=new Date()){return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0]}
function timeNow(){return new Date().toLocaleTimeString("id-ID")}

/* ===== INDEXEDDB for queue ===== */
const DB_NAME="absensiMinimalDB", DB_VER=1; let idb=null;
function idbOpen(){return new Promise(res=>{ if(!("indexedDB" in window)) return res(null); const r=indexedDB.open(DB_NAME,DB_VER); r.onupgradeneeded=e=>{const db=e.target.result; if(!db.objectStoreNames.contains("queue")) db.createObjectStore("queue",{keyPath:"id"})}; r.onsuccess=()=>res(r.result); r.onerror=()=>res(null); })}
function idbAll(){return new Promise(r=>{ if(!idb) return r([]); const tx=idb.transaction("queue","readonly"); const req=tx.objectStore("queue").getAll(); req.onsuccess=()=>r(req.result||[]); req.onerror=()=>r([]); })}
function idbPut(it){return new Promise(r=>{ if(!idb) return r(); const tx=idb.transaction("queue","readwrite"); tx.objectStore("queue").put(it); tx.oncomplete=r; tx.onerror=r; })}
function idbDel(id){return new Promise(r=>{ if(!idb) return r(); const tx=idb.transaction("queue","readwrite"); tx.objectStore("queue").delete(id); tx.oncomplete=r; tx.onerror=r; })}

/* ===== LOAD/SAVE LOCAL ===== */
function loadLocal(){
  try{EMP = JSON.parse(localStorage.getItem(LS.employees))||[]}catch{EMP=[]}
  try{attendance = JSON.parse(localStorage.getItem(LS.attendance))||{}}catch{attendance={}}
  try{queue = JSON.parse(localStorage.getItem(LS.queue))||[]}catch{queue=[]}
  try{const s=JSON.parse(localStorage.getItem(LS.session)); if(s) currentUser = s;}catch{}
}
function saveEmployees(){localStorage.setItem(LS.employees, JSON.stringify(EMP))}
function saveAttendance(){localStorage.setItem(LS.attendance, JSON.stringify(attendance))}
function saveQueue(){localStorage.setItem(LS.queue, JSON.stringify(queue))}
function saveSession(){ if(currentUser) localStorage.setItem(LS.session, JSON.stringify(currentUser)); else localStorage.removeItem(LS.session)}

/* ===== FETCH EMPLOYEES FROM SHEET ===== */
async function fetchEmployees(force=false){
  const last = Number(localStorage.getItem(LS.employeesFetchedAt)||0);
  const stale = Date.now()-last > (12*60*60*1000); // 12 jam
  if(!force && EMP.length && !stale) return EMP;
  try{
    const res = await fetch(ENDPOINT, {method:"GET", cache:"no-store"});
    const data = await res.json();
    if(Array.isArray(data)){
      EMP = data.map(x=>({id:String(x.id||"").trim(), name:String(x.name||x.nama||"").trim(), password:String(x.password||"").trim(), role:(x.role||"user").toLowerCase()}));
      saveEmployees(); localStorage.setItem(LS.employeesFetchedAt, String(Date.now()));
      renderEmpTable();
      return EMP;
    } else {
      toast("Format karyawan tidak valid"); return EMP;
    }
  }catch(e){ toast("Gagal ambil karyawan (offline?)"); return EMP; }
}

/* ===== AUTH ===== */
function findEmp(id){id=String(id||"").trim(); return EMP.find(e=>e.id===id)}
function login(id, pass){
  const u=findEmp(id);
  if(!u) return {ok:false,msg:"User tidak ditemukan"};
  if(String(u.password)!==String(pass)) return {ok:false,msg:"Password salah"};
  currentUser = {id:u.id,name:u.name,role:u.role};
  saveSession();
  showUserView();
  toast("Login sukses");
  return {ok:true}
}

/* ===== VIEWS ===== */
function showLoginView(){
  show(qs("viewLogin")); hide(qs("viewUser")); hide(qs("viewAdmin"));
  hide(qs("btnLogout"));
}
function showUserView(){
  hide(qs("viewLogin")); show(qs("viewUser")); hide(qs("viewAdmin"));
  show(qs("btnLogout"));
  qs("userName").textContent=currentUser.name;
  qs("userId").textContent=currentUser.id;
  qs("userRole").textContent=currentUser.role;
  qs("todayDate").textContent = new Date().toLocaleDateString("id-ID",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  restoreTodayStatus();
}
function showAdminView(){
  hide(qs("viewLogin")); hide(qs("viewUser")); show(qs("viewAdmin"));
  renderEmpTable();
}

/* ===== ATTENDANCE ===== */
function ensureUserDay(uid, date){
  attendance[uid]=attendance[uid]||{};
  attendance[uid][date]=attendance[uid][date]||{shift:"",in:null,out:null};
  return attendance[uid][date];
}
function restoreTodayStatus(){
  const k=todayKey(); const r=(attendance[currentUser.id]||{})[k];
  qs("statusIn").textContent = "Masuk: " + (r && r.in ? r.in : "-");
  qs("statusOut").textContent = "Keluar: " + (r && r.out ? r.out : "-");
  qs("shiftSel").value = (r && r.shift) ? r.shift : "";
}
function enqueueSync(payload){
  const item = { id: `${payload.userId}-${payload.date}-${payload.type}-${Date.now()}`, payload, retries:0, last:0 };
  queue.push(item); saveQueue(); idbPut(item); processQueue();
}
async function processQueue(){
  if(!navigator.onLine){ setSyncState("Offline"); return }
  if(!queue.length){ setSyncState("Sinkron siap"); return }
  setSyncState("Sinkron...");
  const remain = [];
  for(const it of queue){
    try{
      const r = await fetch(ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(it.payload)});
      if(!r.ok) throw new Error("HTTP "+r.status);
      await idbDel(it.id);
    }catch(e){
      it.retries++; it.last=Date.now();
      if(it.retries<12){ remain.push(it); await idbPut(it); }
    }
  }
  queue = remain; saveQueue();
  setSyncState(queue.length? `Tertunda: ${queue.length}` : "Sinkron siap");
}

/* ===== PASSWORD CHANGE ===== */
async function changePassword(targetId, newPass){
  // Optimistic: update local cache first
  const u = findEmp(targetId);
  if(!u) throw new Error("User tidak ditemukan");
  u.password = String(newPass||"").trim();
  saveEmployees(); renderEmpTable();
  // Try server update (requires Apps Script to support this action)
  try{
    const r = await fetch(ENDPOINT, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({action:"updatePassword", id: targetId, password: u.password, changedBy: currentUser ? currentUser.name : "unknown"})});
    if(!r.ok){ throw new Error("HTTP "+r.status) }
    toast("Password diperbarui");
  }catch(e){
    toast("Password lokal diganti. Pastikan Apps Script dukung updatePassword.");
  }
}

/* ===== ADMIN TABLE ===== */
function renderEmpTable(){
  const tbody = qs("tblEmp").querySelector("tbody");
  if(!tbody) return;
  const q = (qs("searchEmp").value||"").toLowerCase();
  const rows = EMP.filter(x=> !q || x.id.toLowerCase().includes(q) || x.name.toLowerCase().includes(q) || x.role.toLowerCase().includes(q));
  qs("empCount").textContent = rows.length;
  tbody.innerHTML="";
  for(const u of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${u.id}</td><td>${u.name}</td><td>${u.role}</td><td>${"*".repeat(Math.max(4,String(u.password).length))}</td>
      <td><button class="btn" data-id="${u.id}">Ganti</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-id");
      const np = prompt("Password baru untuk "+id+":");
      if(np==null || np==="") return;
      try{ await changePassword(id, np) }catch(e){ toast("Gagal: "+e.message) }
    });
  });
}

/* ===== EVENTS ===== */
window.addEventListener("online", ()=>{ setOnlineBadge(); processQueue() });
window.addEventListener("offline", ()=>{ setOnlineBadge(); setSyncState("Offline") });

qs("btnLogin").addEventListener("click", ()=>{
  const id=qs("loginId").value.trim(); const p=qs("loginPass").value;
  const r=login(id,p); qs("loginMsg").textContent = r.ok? "" : r.msg;
});
qs("btnRefreshEmployees").addEventListener("click", async ()=>{
  await fetchEmployees(true); toast("Karyawan diperbarui");
});
qs("btnToAdmin").addEventListener("click", ()=>{
  if(currentUser && currentUser.role==="admin"){ showAdminView(); }
  else {
    const adm = prompt("Masukkan ID admin:"); const pass = prompt("Password admin:");
    const r = login(adm, pass);
    if(r.ok && currentUser.role==="admin"){ showAdminView(); }
    else { toast("Bukan admin"); showLoginView(); currentUser=null; saveSession(); }
  }
});
qs("btnBack").addEventListener("click", ()=>{ if(currentUser) showUserView(); else showLoginView(); });
qs("btnLogout").addEventListener("click", ()=>{ currentUser=null; saveSession(); showLoginView() });
qs("btnReloadEmp").addEventListener("click", async ()=>{ await fetchEmployees(true) });
qs("btnExportLocal").addEventListener("click", ()=>{
  const uidList = Object.keys(attendance);
  const rows = [];
  for(const uid of uidList){
    const per = attendance[uid]||{};
    for(const d of Object.keys(per)){
      const r=per[d];
      rows.push({date:d,userId:uid,in:r.in||"",out:r.out||"",shift:r.shift||""});
    }
  }
  const header = ["date","userId","in","out","shift"];
  const csv = [header.join(",")].concat(rows.map(r=> header.map(k=> `"${String(r[k]||"").replaceAll('"','""')}"`).join(","))).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="absensi-local.csv"; a.click(); URL.revokeObjectURL(a.href);
});
qs("searchEmp").addEventListener("input", renderEmpTable);
qs("btnChangePassSelf").addEventListener("click", async ()=>{
  if(!currentUser) return;
  const np = prompt("Password baru:");
  if(np==null || np==="") return;
  try{ await changePassword(currentUser.id, np); toast("Password diganti"); }
  catch(e){ toast("Gagal: "+e.message) }
});

qs("btnIn").addEventListener("click", ()=>{
  if(!currentUser) return toast("Login dulu");
  const sh = qs("shiftSel").value; if(!sh) return toast("Pilih shift dulu");
  const k=todayKey(); const rec=ensureUserDay(currentUser.id,k); if(rec.in) return toast("Sudah finger in");
  rec.shift=sh; rec.in=timeNow(); saveAttendance(); restoreTodayStatus();
  enqueueSync({timestamp:new Date().toISOString(), userId:currentUser.id, name:currentUser.name, type:"in", date:k, time:rec.in, shift:sh});
});
qs("btnOut").addEventListener("click", ()=>{
  if(!currentUser) return toast("Login dulu");
  const k=todayKey(); const rec=ensureUserDay(currentUser.id,k); if(!rec.in) return toast("Belum finger in"); if(rec.out) return toast("Sudah finger out");
  const sh = rec.shift || qs("shiftSel").value || "";
  rec.out=timeNow(); saveAttendance(); restoreTodayStatus();
  enqueueSync({timestamp:new Date().toISOString(), userId:currentUser.id, name:currentUser.name, type:"out", date:k, time:rec.out, shift:sh||null});
});

/* ===== INIT ===== */
(async function(){
  idb = await idbOpen();
  const qAll = await idbAll();
  loadLocal();
  // merge IDB queue to memory if needed
  if(qAll && qAll.length){
    const map = new Map(queue.map(i=>[i.id,i]));
    qAll.forEach(i=>{ if(!map.has(i.id)) map.set(i.id,i) });
    queue = Array.from(map.values()); saveQueue();
  }
  setOnlineBadge();
  await fetchEmployees(false);
  if(currentUser) showUserView(); else showLoginView();
  processQueue();
  setInterval(()=>{ if(navigator.onLine) processQueue() }, 30000);
})();

/* ===== SERVICE WORKER (inline writer) ===== */
if("serviceWorker" in navigator){
  const swBlob = new Blob([`
    const CACHE="abs-mini-v1";
    const ASSETS=["./","./index.html"];
    self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()))});
    self.addEventListener("activate",e=>{e.waitUntil(self.clients.claim())});
    self.addEventListener("fetch",e=>{
      const url=new URL(e.request.url);
      if(url.origin===location.origin){
        e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{const copy=resp.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return resp;})));
      }
    });
  `], {type:"text/javascript"});
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}
</script>
</body>
</html>
